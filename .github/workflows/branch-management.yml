name: Branch Management

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
  NEON_PROJECT_IDS: 'polished-water-58114712,autumn-bush-97691534,little-salad-54029192'

jobs:
  list-branches:
    runs-on: ubuntu-latest

    steps:
      - name: Install Neon CLI
        run: npm install -g neonctl@latest

      - name: Verify Neon CLI install
        run: |
          neon --version

      - name: List Projects - temp
        run: |
          neon projects list

      - name: List Branches
        run: |

          format_datetime() {
            echo $(date -d "$1" '+%b %d, %Y @%H:%M:%S')
          }

          projects=$(neon projects list --output json)
          IFS=',' read -r -a PROJECT_IDS <<< "$NEON_PROJECT_IDS"

          for project in $(echo "$projects" | jq -c '.projects[]'); do
            PROJECT_ID=$(echo "$project" | jq -r '.id')
            PROJECT_NAME=$(echo "$project" | jq -r '.name')
            
            if [[ " ${PROJECT_IDS[@]} " =~ " ${PROJECT_ID} " ]]; then
              echo -e "📌 Project ID: $PROJECT_ID | 📄 Project Name: $PROJECT_NAME\n"
              
              branches=$(neon branches list --project-id "$PROJECT_ID" --output json)

              branches=$(echo "$branches" | jq -c 'sort_by(.created_at)')
              
              if [ -z "$branches" ]; then
                echo "⚠️ No branches found for project 📄 $PROJECT_NAME"
              else
                for branch in $(echo "$branches" | jq -c '.[]'); do
                  echo "$branch" | jq .
                  IS_PRIMARY=$(echo "$branch" | jq -r '.primary')
                  CREATOR_NAME=$(echo "$branch" | jq -r '.created_by.name')
                  BRANCH_ID=$(echo "$branch" | jq -r '.id')
                  BRANCH_NAME=$(echo "$branch" | jq -r '.name')
                  CREATED_AT=$(echo "$branch" | jq -r '.created_at')
                  UPDATED_AT=$(echo "$branch" | jq -r '.updated_at')

                  FORMATTED_CREATED_AT=$(format_datetime "$CREATED_AT")
                  FORMATTED_UPDATED_AT=$(format_datetime "$UPDATED_AT")

                  if [ "$IS_PRIMARY" == "true" ]; then
                    BRANCH_ICON="⭐"  # Star icon if primary
                  else
                    BRANCH_ICON="🌿"  # Default branch icon
                  fi

                  echo -e "  $BRANCH_ICON Branch ID: $BRANCH_ID\n    📄 Name: $BRANCH_NAME\n    ⏱️ Created: $FORMATTED_CREATED_AT\n    ⏰ Last Updated: $FORMATTED_UPDATED_AT\n    👤 Created by: $CREATOR_NAME\n"

                done
                echo "---"
              fi
            fi
          done
